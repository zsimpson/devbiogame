<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DevBio Game</title>
	<link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js"></script>
    <script src="./z.js"></script>
	<script src="./state.js"></script>
	<script src="./render.js"></script>
	<style type="text/css">
        #main-canvas {
            width: 100%;
            height: auto;
        }
	</style>
	<script>
	    //let ss = { a:1 };

        $(document).ready(function() {

            stateInit();

            function zDropdownSelect(btnClass, title, options) {
                // Make a dropdown select menu with title and options
                // When clicked, the title will become the selected option.
                return z("div.dropdown-select",
                    z(`a.btn.dropdown-toggle${btnClass}`,
                        {
                            data: { toggle: "dropdown" },
                            href: "#",
                        },
                        title
                    ),
                    z("ul.dropdown-menu",
                        options.map( (option) => {
                            return z("li.dropdown-item", z("a", { href: "#" }, `${option}`) );
                        }),
                    ),
                );
            }

            let zCanvas = z("canvas#main-canvas", {width: n * d, height: n * d});

            let zMain = z("div.p-3",
                z("div.row",
                    z("div.col-4",
                        z("div#op-lines-container"),
                    ),
                    z("div.col",
                        z("div.btn-toolbar.mb-2",
                            z("button.btn.btn-success.mr-2#step", {type:"button"},
                                z("span.fa.fa-step-forward.mr-2", {"aria-hidden":"true"}),
                                "Step"
                            ),
                            z("button.btn.btn-success.mr-2#play", {type:"button"},
                                z("span.fa.fa-play.mr-2", {"aria-hidden":"true"}),
                                "Play"
                            ),
                            z("button.btn.btn-success.mr-2#pause", {type:"button"},
                                z("span.fa.fa-pause.mr-2", {"aria-hidden":"true"}),
                                "Pause"
                            ),
                            z("button.btn.btn-success.mr-2#clear", {type:"button"},
                                z("span.fa.fa-stop.mr-2", {"aria-hidden":"true"}),
                                "Clear"
                            ),
                        ),
                        z("div", zCanvas),
                    ),
                ),
            );

            $("#main").html(zMain);

            $("#main").on("click", ".dropdown-menu li", function() {
                // Called when any dropdown is click; SET the text and trigger a change
                // This is generic to all dropdowns. The .change() callbacks on
                // specific dropdown classes is what implements the business logic
                // for each kind of dropdown.
                let selText = $(this).find("a").text();
                $(this).closest(".dropdown-select").find(".dropdown-toggle").text(selText).change();
            });

            function zOperands(operands) {
                // opState is an array of objects like: { operand: "Variable", options: stateVarNames }
                // In the case that this is generic (not from a saved state) then the
                // operand will be something like: "Direction". But once it is set it will be like "West".

                return operands.map( (operand) => {
                    if("label" in operand) {
                        return z("span", `${operand.label}:`);
                    }
                    else {
                        return z("div.btn-group.mr-2",
                            zDropdownSelect(".operand.btn-info", operand.operand, operand.options)
                        );
                    }
                });
            }

            function zOpLines(opStates) {
                // opStates is a list of opStates
                return z("ul.list-group#op-lines",
                    opStates.map( (opState, i) => {
                        // Make a operation line which is a line number, an operation dropdown, and
                        // a list of operand dropdowns.
                        return z("li.list-group-item.d-flex.align-items-center",
                            z("span.badge.badge-secondary.badge-pill.mr-4", `${i + 1}`),
                            z("div.btn-toolbar.op-line",
                                z("div.btn-group.mr-2",
                                   zDropdownSelect(".operation.btn-primary", opState.operation, Object.keys(opsDefaults)),
                                ),
                                z("div.operands",
                                    zOperands(opState.operands)
                                ),
                            ),
                        );
                    }),
                );
            }

            $("#main").on("change", ".operation", function() {
                // Called when any operation changes; REPLACE the operands
                let operation = $(this).text();
                let operands = opsDefaults[operation];
                $(this).closest(".op-line").find(".operands").html(
                    zOperands(operands),
                );
            });

            $("#main").on("change", ".operand", function() {
                compileFromUI();
            });

            function updateAndRender() {
                stateUpdate();
                render();
            }

            function buttonPlayState(play) {
                if(play) {
                    $("#pause").addClass("d-none");
                    $("#play").removeClass("d-none");
                }
                else {
                    $("#pause").removeClass("d-none");
                    $("#play").addClass("d-none");
                }
            }

            buttonPlayState(true);

            $("#step").click(function() {
                updateAndRender();
            });

            let runnerHandle = null;
            $("#play").click( function() {
                buttonPlayState(false);
                runnerHandle = setInterval(updateAndRender, 1);
            });

            $("#pause").click( function() {
                buttonPlayState(true);
                clearInterval(runnerHandle);
                runnerHandle = null;
            });

            $("#clear").click( function() {
                buttonPlayState(true);
                clearInterval(runnerHandle);
                stateInit();
                render();
            });

            function compileFromUI() {
                let opStates = $("#op-lines-container").find(".operation").map( function() {
                    let operation = $(this).text();
                    let operands = $(this).closest(".op-line").find(".operand").map( function(i) {
                        return {
                            operand: $(this).text(),
                            options: opsDefaults[operation][i].options,
                        }
                    }).get();
                    return {operation, operands};
                }).get();

                window.localStorage.setItem("savedOpsVersion", JSON.stringify(opsVersion));
                window.localStorage.setItem("savedOpsStates", JSON.stringify(opStates));

                stateCompile(opStates);
                stateInit();
            }


            // LOAD saved opStates or invalidate if version does not match
            let savedOpsVersion = window.localStorage.getItem("savedOpsVersion");
            let savedOpsStates = window.localStorage.getItem("savedOpsStates");
            if (savedOpsVersion != opsVersion ) {
                savedOpsStates = new Array(4).fill().map( (_,i) => {
                    return {
                        operation: "Operation",
                        operands: [],
                    }
                });
            }
            else {
                savedOpsStates = JSON.parse(savedOpsStates);
            }

            // SETUP the UI state from the loaded savedOpsStates
            $("#op-lines-container").html(
                zOpLines(savedOpsStates)
            );

            renderInit($("#main-canvas")[0]);
            compileFromUI();
            render();
        });

	</script>
</head>
<body>
    <div id="main"></div>
    <div>
        <h2>To Do</h2>
        <ol>
            <li>Contention rules</li>
            <li>Concept of a level (n, may change, some things allowed others not, num lines)</li>
            <li>Code line delete, add, etc.</li>
            <li>Setup an s3 bucket to server this</li>
        </ol>
    </div>
</body>
</html>
