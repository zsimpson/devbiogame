<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DevBio Game</title>
	<link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js"></script>
	<script src="./z.js"></script>
	<script src="./state.js"></script>
	<script src="./render.js"></script>
	<style type="text/css">
        #main-canvas {
            width: 100%;
            height: auto;
        }
	</style>
	<script>
        $(document).ready(function() {

            stateInit();

            function zDropdownSelect(btnClass, title, options) {
                return z("span.dropdown-select",
                    z(`a.btn.btn-primary.dropdown-toggle${btnClass}`,
                        {
                            data: { toggle: "dropdown" },
                            href: "#",
                        },
                        title
                    ),
                    z("ul.dropdown-menu",
                        options.map( (option) => {
                            return z("li.dropdown-item", z("a", { href: "#" }, `${option}`) );
                        }),
                    ),
                );
            }

            function zOpLine(lineI) {
                return z("li.list-group-item",
                    z("span.badge.badge-primary.badge-pill", `${lineI + 1}`),
                    z("div.btn-group.op-line",
                        zDropdownSelect(".operation", "Operation", Object.keys(operations)),
                        z("div.operands"),
                    )
                );
            }

            let zOpLines = z("ul.list-group#op-lines",
                Array(4).fill().map( (_, i) => {
                    return zOpLine(i);
                }),
            );

            let zCanvas = z("canvas#main-canvas", {width: n * d, height: n * d});

            let zMain = z("div.container-fluid.p-3",
                z("div.row",
                    z("div.col-5",
                        zOpLines,
                        z("div", z("button#step", "Step")),
                    ),
                    z("div.col", zCanvas),
                ),
            );

            $("#main").html(zMain);

            $("#main").on("click", ".dropdown-menu li", function() {
                // Called when any dropdown is click; SET the text and trigger a change
                let selText = $(this).find("a").text();
                $(this).closest(".dropdown-select").find(".dropdown-toggle").text(selText).change();
            });

            $(".operation").change( function() {
                // Called when any operation changes; REPLACE the operands
                let operation = $(this).text();
                let operandDicts = operations[operation];
                $(this).closest(".op-line").find(".operands").html(
                    operandDicts.map( (operandDict) => {
                        if("label" in operandDict) {
                            return z("span", `${operandDict.label}:`);
                        }
                        else {
                            return zDropdownSelect(".operand", operandDict.operand, operandDict.options);
                        }
                    }),
                );

                $(".operand").change( function() {
                    compileFromUI();
                });

                compileFromUI();
            });

            $("#step").click( function() {
                updateAndRender();
            });

            function compileFromUI() {
                let rawOpLines = [];
                $("#op-lines").find(".operation").each( (lineI, line) => {
                    let operation = $(line).text();
                    let operands = [];
                    $(line).closest(".op-line").find(".operand").each( (operandI, operand) => {
                        operands.push($(operand).text());
                    });
                    rawOpLines.push({operation, operands});
                });

                stateCompile(rawOpLines);
                stateRestart();
            }

            renderInit($("#main-canvas")[0]);

            function updateAndRender() {
                stateUpdate();
                render();
            }
        });

	</script>
</head>
<body id="main" class="container">
</body>
</html>
